# PR-10 警报引擎扫描系统产品需求文档

## 1. 产品概述

本需求旨在为古灵通股票投资平台构建智能警报引擎扫描系统，实现自动化的股票价格监控和用户通知功能。

- 解决用户痛点：用户需要实时监控股票价格变化，及时获得投资机会和风险提示
- 提升用户体验：通过自动化扫描和智能通知，减少用户手动监控的工作量
- 增强平台价值：提供专业的股票监控服务，提升用户粘性和平台竞争力

## 2. 核心功能

### 2.1 用户角色

本功能面向所有注册用户，支持个性化警报规则配置。

### 2.2 功能模块

本需求包含以下核心功能模块：

1. **警报规则管理**: 用户创建、编辑、删除股票价格警报规则
2. **定时扫描引擎**: 每5分钟自动扫描所有活跃的警报规则
3. **数据源集成**: 从Mock数据源切换到ProviderX实时数据源
4. **通知系统**: 规则命中时生成用户通知，支持幂等机制
5. **通知接口**: 提供API接口供用户查询个人通知记录

### 2.3 页面详情

| 页面名称     | 模块名称      | 功能描述                                               |
| ------------ | ------------- | ------------------------------------------------------ |
| 警报规则管理 | 规则创建      | 用户设置股票代码、价格条件（大于/小于/等于）、触发阈值 |
| 警报规则管理 | 规则编辑      | 修改现有规则的触发条件和阈值设置                       |
| 警报规则管理 | 规则状态      | 启用/禁用规则，查看规则执行历史                        |
| 定时扫描引擎 | 扫描调度      | 每5分钟执行一次全量扫描，支持手动触发                  |
| 定时扫描引擎 | 规则匹配      | 获取实时股价数据，与用户规则进行匹配判断               |
| 定时扫描引擎 | 命中处理      | 规则命中时记录通知，实现幂等机制                       |
| 数据源管理   | ProviderX集成 | 从ProviderX获取实时股票价格数据                        |
| 数据源管理   | 数据缓存      | 缓存股价数据，减少API调用频率                          |
| 通知系统     | 通知生成      | 按user+symbol+rule+day维度生成唯一通知                 |
| 通知系统     | 幂等控制      | 同一用户同一股票同一规则同一天只生成一条通知           |
| 通知接口     | 个人通知      | /api/me/notifications接口返回用户通知列表              |
| 通知接口     | 分页查询      | 支持分页、筛选和排序功能                               |

## 3. 核心流程

### 3.1 警报扫描流程

系统每5分钟执行一次扫描任务，获取所有活跃的警报规则，从ProviderX获取对应股票的实时价格，进行规则匹配。当规则命中时，按照user+symbol+rule+day的组合键检查是否已存在通知，如不存在则创建新通知记录。

### 3.2 通知查询流程

用户通过/api/me/notifications接口查询个人通知，支持按时间范围、股票代码、规则类型等条件筛选，返回分页结果。

```mermaid
graph TD
    A[定时任务启动] --> B[获取活跃警报规则]
    B --> C[从ProviderX获取股价数据]
    C --> D[规则匹配判断]
    D --> E{规则是否命中?}
    E -->|是| F[检查通知幂等性]
    E -->|否| G[继续下一条规则]
    F --> H{今日已通知?}
    H -->|否| I[创建通知记录]
    H -->|是| G
    I --> J[发送通知给用户]
    J --> G
    G --> K{还有规则?}
    K -->|是| D
    K -->|否| L[扫描完成]

    M[用户请求通知] --> N[/api/me/notifications]
    N --> O[查询用户通知记录]
    O --> P[返回分页结果]
```

## 4. 用户界面设计

### 4.1 设计风格

- **主色调**: 成功绿色 #52C41A，警告橙色 #FA8C16，危险红色 #FF4D4F
- **辅助色**: 信息蓝色 #1890FF，中性灰色 #8C8C8C
- **按钮样式**: 圆角按钮，支持不同状态（启用/禁用/触发）
- **字体**: 系统默认字体，标题 16px，正文 14px，辅助信息 12px
- **布局风格**: 列表卡片式设计，支持筛选和排序
- **图标风格**: 使用警报、通知、股票等语义化图标

### 4.2 页面设计概览

| 页面名称     | 模块名称 | UI元素                                       |
| ------------ | -------- | -------------------------------------------- |
| 警报规则列表 | 规则卡片 | 股票代码、触发条件、阈值、状态开关、操作按钮 |
| 警报规则列表 | 创建按钮 | 浮动操作按钮，快速创建新规则                 |
| 规则创建页面 | 表单组件 | 股票选择器、条件下拉框、数值输入框、确认按钮 |
| 规则创建页面 | 预览区域 | 实时显示规则描述和当前股价对比               |
| 通知中心     | 通知列表 | 时间戳、股票信息、触发条件、规则描述         |
| 通知中心     | 筛选器   | 时间范围选择、股票筛选、规则类型筛选         |
| 通知详情     | 详情卡片 | 完整的触发信息、股价变化图表、相关建议       |

### 4.3 响应式设计

- **桌面端优先**: 支持大屏显示，多列布局展示更多信息
- **移动端适配**: 单列布局，优化触摸操作体验
- **实时更新**: 支持WebSocket实时推送通知更新
- **离线支持**: 缓存重要数据，支持离线查看历史通知
