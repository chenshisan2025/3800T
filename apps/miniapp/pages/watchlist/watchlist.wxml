<!--pages/watchlist/watchlist.wxml-->
<view class="watchlist-page">
  <!-- 骨架屏 -->
  <skeleton 
    wx:if="{{loading && !refreshing}}" 
    type="market" 
    count="6" 
    show-avatar="{{false}}" 
    show-subtitle="{{true}}"
  />
  
  <!-- 错误占位 -->
  <error-placeholder 
    wx:elif="{{error && !loading}}" 
    type="{{errorType}}" 
    title="{{errorTitle}}" 
    description="{{errorDescription}}" 
    bind:retry="handleRetry" 
    bind:refresh="handleRefresh"
  />
  
  <!-- 主要内容 -->
  <view wx:else class="watchlist-content">
    <!-- 头部栏 -->
    <view class="header-bar">
      <text class="header-title">我的自选</text>
      <view class="header-actions">
        <text wx:if="{{!editMode && watchlist.length > 0}}" class="action-btn" bindtap="enterEditMode">编辑</text>
        <view wx:elif="{{editMode}}" class="edit-actions">
          <text class="action-btn" bindtap="onSelectAll">
            {{selectedStocks.length === watchlist.length ? '取消全选' : '全选'}}
          </text>
          <text class="action-btn" bindtap="exitEditMode">取消</text>
        </view>
      </view>
    </view>

    <!-- 未登录状态 -->
    <view wx:if="{{!isLogin}}" class="login-prompt">
    <view class="login-content">
      <text class="login-icon">👤</text>
      <text class="login-title">请先登录</text>
      <text class="login-desc">登录后可以添加自选股票</text>
      <button class="login-btn" bindtap="onLoginTap">立即登录</button>
    </view>
  </view>

    <!-- 主要内容 -->
    <view wx:else class="content">
    <!-- 空状态 -->
    <view wx:if="{{watchlist.length === 0}}" class="empty">
      <view class="empty-content">
        <text class="empty-icon">📈</text>
        <text class="empty-title">暂无自选股票</text>
        <text class="empty-desc">添加股票到自选，随时关注价格变化</text>
        <button class="add-btn" bindtap="onAddStockTap">添加自选股</button>
      </view>
    </view>

    <!-- 有数据状态 -->
    <view wx:else>
      <!-- 排序栏 -->
      <view class="sort-bar">
        <view class="sort-item" bindtap="onSort" data-field="name">
          <text class="sort-text">名称</text>
        </view>
        <view class="sort-item" bindtap="onSort" data-field="price">
          <text class="sort-text">现价 {{getSortIcon('price')}}</text>
        </view>
        <view class="sort-item" bindtap="onSort" data-field="changePercent">
          <text class="sort-text">涨跌幅 {{getSortIcon('changePercent')}}</text>
        </view>
        <view class="sort-item" bindtap="onSort" data-field="addTime">
          <text class="sort-text">添加时间 {{getSortIcon('addTime')}}</text>
        </view>
      </view>

      <!-- 股票列表 -->
      <scroll-view 
        scroll-y="true" 
        class="stock-scroll" 
        refresher-enabled="{{true}}" 
        refresher-triggered="{{refreshing}}" 
        bindrefresherrefresh="refreshData"
      >
        <view class="stock-list">
          <view 
            class="stock-item {{editMode ? 'edit-mode' : ''}} {{isStockSelected(item.code) ? 'selected' : ''}}" 
            wx:for="{{watchlist}}" 
            wx:key="code"
            bindtap="onStockTap" 
            data-code="{{item.code}}"
          >
            <!-- 选择框 -->
            <view wx:if="{{editMode}}" class="select-box">
              <view class="checkbox {{isStockSelected(item.code) ? 'checked' : ''}}"></view>
            </view>

            <!-- 股票信息 -->
            <view class="stock-info">
              <text class="stock-name">{{item.name}}</text>
              <text class="stock-code">{{item.code}}</text>
            </view>

            <!-- 价格信息 -->
            <view class="stock-price">
              <text class="price-value">{{formatPrice(item.price)}}</text>
            </view>

            <!-- 涨跌信息 -->
            <view class="stock-change">
              <text class="change-percent {{getChangeColorClass(item.change)}}">
                {{formatChangePercent(item.changePercent)}}
              </text>
              <text class="change-value {{getChangeColorClass(item.change)}}">
                {{formatChange(item.change)}}
              </text>
            </view>

            <!-- 添加时间 -->
            <view class="stock-time">
              <text class="time-value">{{formatTime(item.addTime)}}</text>
            </view>

            <!-- 删除按钮 -->
            <view wx:if="{{!editMode}}" class="delete-btn" bindtap="onDeleteStock" data-code="{{item.code}}">
              <text class="delete-icon">×</text>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- 底部操作栏 -->
      <view wx:if="{{editMode}}" class="bottom-bar">
        <view class="selected-info">
          <text class="selected-text">已选择 {{selectedStocks.length}} 只股票</text>
        </view>
        <button class="delete-btn-bottom" bindtap="onDeleteSelected" disabled="{{selectedStocks.length === 0}}">
          删除选中
        </button>
      </view>

      <!-- 添加按钮 -->
      <view wx:if="{{!editMode}}" class="add-float-btn" bindtap="onAddStockTap">
        <text class="add-icon">+</text>
      </view>
    </view>
  </view>
</view>