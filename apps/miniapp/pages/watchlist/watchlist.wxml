<!--pages/watchlist/watchlist.wxml-->
<view class="watchlist-page">
  <!-- éª¨æ¶å± -->
  <skeleton 
    wx:if="{{loading && !refreshing}}" 
    type="market" 
    count="6" 
    show-avatar="{{false}}" 
    show-subtitle="{{true}}"
  />
  
  <!-- é”™è¯¯å ä½ -->
  <error-placeholder 
    wx:elif="{{error && !loading}}" 
    type="{{errorType}}" 
    title="{{errorTitle}}" 
    description="{{errorDescription}}" 
    bind:retry="handleRetry" 
    bind:refresh="handleRefresh"
  />
  
  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else class="watchlist-content">
    <!-- å¤´éƒ¨æ  -->
    <view class="header-bar">
      <text class="header-title">æˆ‘çš„è‡ªé€‰</text>
      <view class="header-actions">
        <text wx:if="{{!editMode && watchlist.length > 0}}" class="action-btn" bindtap="enterEditMode">ç¼–è¾‘</text>
        <view wx:elif="{{editMode}}" class="edit-actions">
          <text class="action-btn" bindtap="onSelectAll">
            {{selectedStocks.length === watchlist.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
          </text>
          <text class="action-btn" bindtap="exitEditMode">å–æ¶ˆ</text>
        </view>
      </view>
    </view>

    <!-- æœªç™»å½•çŠ¶æ€ -->
    <view wx:if="{{!isLogin}}" class="login-prompt">
    <view class="login-content">
      <text class="login-icon">ğŸ‘¤</text>
      <text class="login-title">è¯·å…ˆç™»å½•</text>
      <text class="login-desc">ç™»å½•åå¯ä»¥æ·»åŠ è‡ªé€‰è‚¡ç¥¨</text>
      <button class="login-btn" bindtap="onLoginTap">ç«‹å³ç™»å½•</button>
    </view>
  </view>

    <!-- ä¸»è¦å†…å®¹ -->
    <view wx:else class="content">
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{watchlist.length === 0}}" class="empty">
      <view class="empty-content">
        <text class="empty-icon">ğŸ“ˆ</text>
        <text class="empty-title">æš‚æ— è‡ªé€‰è‚¡ç¥¨</text>
        <text class="empty-desc">æ·»åŠ è‚¡ç¥¨åˆ°è‡ªé€‰ï¼Œéšæ—¶å…³æ³¨ä»·æ ¼å˜åŒ–</text>
        <button class="add-btn" bindtap="onAddStockTap">æ·»åŠ è‡ªé€‰è‚¡</button>
      </view>
    </view>

    <!-- æœ‰æ•°æ®çŠ¶æ€ -->
    <view wx:else>
      <!-- æ’åºæ  -->
      <view class="sort-bar">
        <view class="sort-item" bindtap="onSort" data-field="name">
          <text class="sort-text">åç§°</text>
        </view>
        <view class="sort-item" bindtap="onSort" data-field="price">
          <text class="sort-text">ç°ä»· {{getSortIcon('price')}}</text>
        </view>
        <view class="sort-item" bindtap="onSort" data-field="changePercent">
          <text class="sort-text">æ¶¨è·Œå¹… {{getSortIcon('changePercent')}}</text>
        </view>
        <view class="sort-item" bindtap="onSort" data-field="addTime">
          <text class="sort-text">æ·»åŠ æ—¶é—´ {{getSortIcon('addTime')}}</text>
        </view>
      </view>

      <!-- è‚¡ç¥¨åˆ—è¡¨ -->
      <scroll-view 
        scroll-y="true" 
        class="stock-scroll" 
        refresher-enabled="{{true}}" 
        refresher-triggered="{{refreshing}}" 
        bindrefresherrefresh="refreshData"
      >
        <view class="stock-list">
          <view 
            class="stock-item {{editMode ? 'edit-mode' : ''}} {{isStockSelected(item.code) ? 'selected' : ''}}" 
            wx:for="{{watchlist}}" 
            wx:key="code"
            bindtap="onStockTap" 
            data-code="{{item.code}}"
          >
            <!-- é€‰æ‹©æ¡† -->
            <view wx:if="{{editMode}}" class="select-box">
              <view class="checkbox {{isStockSelected(item.code) ? 'checked' : ''}}"></view>
            </view>

            <!-- è‚¡ç¥¨ä¿¡æ¯ -->
            <view class="stock-info">
              <text class="stock-name">{{item.name}}</text>
              <text class="stock-code">{{item.code}}</text>
            </view>

            <!-- ä»·æ ¼ä¿¡æ¯ -->
            <view class="stock-price">
              <text class="price-value">{{formatPrice(item.price)}}</text>
            </view>

            <!-- æ¶¨è·Œä¿¡æ¯ -->
            <view class="stock-change">
              <text class="change-percent {{getChangeColorClass(item.change)}}">
                {{formatChangePercent(item.changePercent)}}
              </text>
              <text class="change-value {{getChangeColorClass(item.change)}}">
                {{formatChange(item.change)}}
              </text>
            </view>

            <!-- æ·»åŠ æ—¶é—´ -->
            <view class="stock-time">
              <text class="time-value">{{formatTime(item.addTime)}}</text>
            </view>

            <!-- åˆ é™¤æŒ‰é’® -->
            <view wx:if="{{!editMode}}" class="delete-btn" bindtap="onDeleteStock" data-code="{{item.code}}">
              <text class="delete-icon">Ã—</text>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- åº•éƒ¨æ“ä½œæ  -->
      <view wx:if="{{editMode}}" class="bottom-bar">
        <view class="selected-info">
          <text class="selected-text">å·²é€‰æ‹© {{selectedStocks.length}} åªè‚¡ç¥¨</text>
        </view>
        <button class="delete-btn-bottom" bindtap="onDeleteSelected" disabled="{{selectedStocks.length === 0}}">
          åˆ é™¤é€‰ä¸­
        </button>
      </view>

      <!-- æ·»åŠ æŒ‰é’® -->
      <view wx:if="{{!editMode}}" class="add-float-btn" bindtap="onAddStockTap">
        <text class="add-icon">+</text>
      </view>
    </view>
  </view>
</view>