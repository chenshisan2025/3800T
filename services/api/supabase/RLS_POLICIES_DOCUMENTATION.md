# Supabase RLS 策略文档

## 概述

本文档记录了为 PR-04 实现的行级安全（Row Level Security, RLS）策略。这些策略确保用户只能访问和操作属于自己的数据，提供了强大的数据安全保障。

## 已启用 RLS 的表

以下表已成功启用 RLS 并实现了 owner 策略：

### 1. user_watchlist

- **用途**: 用户股票关注列表
- **策略**: 用户只能查看、添加、修改和删除自己的关注列表项目
- **关键字段**: `user_id`

### 2. analysis_reports

- **用途**: 分析报告
- **策略**: 用户只能访问自己创建的分析报告
- **关键字段**: `user_id`

### 3. ai_reports

- **用途**: AI 生成的分析报告
- **策略**: 用户只能访问自己的 AI 报告
- **关键字段**: `user_id`

### 4. withdrawal_requests

- **用途**: 提现申请
- **策略**: 用户只能查看和管理自己的提现申请
- **关键字段**: `user_id`

### 5. wallet_transactions

- **用途**: 钱包交易记录
- **策略**: 用户只能查看属于自己钱包的交易记录
- **关键字段**: `wallet_id` (通过 `user_wallets` 表关联到 `user_id`)

### 6. user_wallets

- **用途**: 用户钱包
- **策略**: 用户只能访问自己的钱包信息
- **关键字段**: `user_id`

### 7. subscriptions

- **用途**: 用户订阅
- **策略**: 用户只能查看和管理自己的订阅
- **关键字段**: `user_id`

### 8. invitations

- **用途**: 邀请记录
- **策略**: 用户只能查看自己发出或接收的邀请
- **关键字段**: `inviter_id`, `invitee_id`

### 9. referral_rewards

- **用途**: 推荐奖励
- **策略**: 用户只能查看自己作为邀请者或被邀请者的奖励记录
- **关键字段**: `inviter_id`, `invitee_id`

### 10. user_coupons

- **用途**: 用户优惠券
- **策略**: 用户只能查看和使用自己的优惠券
- **关键字段**: `user_id`

## 实现的策略类型

每个表都实现了以下四种基本策略：

1. **SELECT 策略**: 用户只能查看自己的数据
2. **INSERT 策略**: 用户只能插入属于自己的数据
3. **UPDATE 策略**: 用户只能更新自己的数据
4. **DELETE 策略**: 用户只能删除自己的数据

## 权限授予

为确保策略正常工作，已为以下角色授予了必要的表权限：

- **authenticated**: 已登录用户，拥有对所有表的完整访问权限（受 RLS 策略限制）
- **anon**: 匿名用户，拥有基本的读取权限（受 RLS 策略限制）

## 特殊实现说明

### wallet_transactions 表

该表通过 `wallet_id` 与用户关联，策略使用子查询来验证钱包所有权：

```sql
wallet_id IN (SELECT id FROM user_wallets WHERE user_id = auth.uid())
```

### invitations 和 referral_rewards 表

这些表涉及两个用户（邀请者和被邀请者），策略允许双方都能访问相关记录：

```sql
auth.uid() = inviter_id OR auth.uid() = invitee_id
```

## 安全保障

1. **数据隔离**: 每个用户只能访问属于自己的数据
2. **防止数据泄露**: RLS 在数据库层面强制执行访问控制
3. **API 安全**: 即使应用层代码有漏洞，数据库层面的 RLS 仍能保护数据
4. **审计友好**: 所有数据访问都受到 RLS 策略的监控和限制

## 迁移信息

- **迁移文件**: `enable_rls_policies.sql`
- **应用时间**: 已成功应用
- **影响表数**: 10 个用户相关表
- **策略总数**: 40 个（每表 4 个策略）

## 验证状态

✅ 所有目标表已成功启用 RLS  
✅ 所有 owner 策略已正确创建  
✅ 权限已正确授予相关角色  
✅ 迁移脚本已成功应用

## 后续维护

1. 定期检查 RLS 策略的有效性
2. 在添加新的用户相关表时，确保启用相应的 RLS 策略
3. 监控策略性能，必要时进行优化
4. 保持文档更新，记录任何策略变更
